<template>
  <el-dialog
    :visible.sync="dialogVisible"
    title="基本信息"
    width="700px"
    top="5vh"
    class="detail"
    :close-on-click-modal="false"
  >
    <main>
      <div>
        <el-form
          ref="ruleForm"
          label-position="right"
          label-width="150px"
          :model="ruleForm"
          :rules="rule"
        >
          <el-form-item label="数据集名称" class="item" prop="set_name">
            <el-input
              v-model="ruleForm.datas_name"
              placeholder="请输入数据集名称"
              style="width: 200px"
            />
          </el-form-item>
          <el-form-item label="描述">
            <el-input
              v-model="ruleForm.des"
              placeholder="请输入描述"
              style="width: 200px"
            />
          </el-form-item>
          <el-form-item label="数据源名称" prop="ds_id">
            <el-select
              v-model="ruleForm.ds_id"
              placeholder="请选择数据源名称"
              @change="getSchemaName"
            >
              <el-option
                v-for="item in sourceOption"
                :key="item.id"
                :label="item.ds_name"
                :value="item.id"
              />
            </el-select>
          </el-form-item>
          <el-form-item label="schema名称" prop="schema_name">
            <el-select
              v-model="ruleForm.schema_name"
              placeholder="请选择schema名称"
              @change="getTableName"
              clearable
            >
              <el-option
                v-for="(item, index) in schemaOption"
                :key="index"
                :label="item"
                :value="item"
              />
            </el-select>
          </el-form-item>
          <el-form-item label="表名称" prop="table_name">
            <el-select
              v-model="ruleForm.table_name"
              placeholder="请选择表名称"
              filterable
              @change="getFiledInfo"
              clearable
            >
              <el-option
                v-for="(item, index) in tableOption"
                :key="index"
                :label="item.table_name + '\t' + item.comments"
                :value="item.table_name"
              />
            </el-select>
          </el-form-item>

          <div class="field_main">
            <div class="field_head">
              <h3>where语句</h3>
              <el-row>
                <el-col :span="12"
                  ><el-form-item label="id" prop="doc_field">
                    <el-select
                      v-model="ruleForm.id_field"
                      placeholder="请选择"
                      filterable
                    >
                      <el-option
                        v-for="(item, index) in fieldList"
                        :key="index"
                        :label="item.column_name + '\t' + item.comments"
                        :value="item.column_name"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="doc" prop="doc_field">
                    <el-select
                      v-model="ruleForm.doc_field"
                      placeholder="请选择"
                      filterable
                    >
                      <el-option
                        v-for="(item, index) in fieldList"
                        :key="index"
                        :label="item.column_name + '\t' + item.comments"
                        :value="item.column_name"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>
              </el-row>
            </div>
            <div>
              <div>
                <el-input
                  v-model="ruleForm.where_clause"
                  type="textarea"
                  placeholder="exp：where field = xxx"
                  limit="10"
                  show-word-limit
                  :autosize="{ minRows: 8.5, maxRows: 20 }"
                />
              </div>
            </div>
            <div>
              <el-button type="primary" class="conn">测试连接</el-button>
            </div>
          </div>
        </el-form>

        <!-- 测试返回数据 -->
        <div class="test-res-data">
          <el-table :data="testResData" border style="width: 100%">
            <el-table-column prop="date" label="id" width="" />
            <el-table-column prop="name" label="doc" width="" />
            <el-table-column prop="" label="" width="" />
            <el-table-column prop="" label="" width="" />
          </el-table>
        </div>
      </div>
    </main>
    <span slot="footer" class="dialog-footer">
      <el-button @click="dialogVisible = false">取 消</el-button>
      <el-button type="primary" @click="handleAdd">确 定</el-button>
    </span>
  </el-dialog>
</template>

<script>
import {
  setDetail,
  setField,
  setSchema,
  setTable,
  setDsList,
  setAddEditor,
} from "@/api/dataset";

export default {
  name: "Detail",
  components: {},
  props: {
    info: {
      type: Object,
      default: () => {
        return {};
      },
    },
  },
  data() {
    return {
      dialogVisible: false,
      sourceOption: [],
      schemaOption: [],
      tableOption: [],
      fieldList: [],
      active: true,
      testResData: [],
      ruleForm: {
        datas_name: "",
        des: "",
        ds_id: "",
        source_name: "",
        schema_name: "",
        table_name: "",
        id_field: "",
        doc_field: "",
        where_clause: "",
      },
      rule: {
        datas_name: [
          { required: true, message: "请输入数据集名称", trigger: "blur" },
        ],
        describe: [{ required: true, message: "请输入描述", trigger: "blur" }],
        ds_id: [
          { required: true, message: "选择数据源不能为空", trigger: "blur" },
        ],
        schema_name: [
          { required: true, message: "选择不能为空", trigger: "blur" },
        ],
        table_name: [
          { required: true, message: "选择不能为空", trigger: "blur" },
        ],
        id_field: [{ required: true, message: "请选择id", trigger: "blur" }],
        doc_field: [{ required: true, message: "请选择doc", trigger: "blur" }],
      },
      type: 0,
      datas_id: "",
    };
  },
  computed: {},
  mounted() {
    this.getDsName();
  },
  methods: {
    opendialog(id, type) {
      this.dialogVisible = true;
      this.type = type;
      if (type) {
        const data = {
          datas_id: id,
        };
        setDetail(data).then((res) => {
          console.log("详情", res.data);
          this.ruleForm = res.data;
        });
        this.datas_id = id;
      } else {
        this.ruleForm = {};
      }
    },
    // 编辑新增
    handleAdd() {
      this.$refs["ruleForm"].validate(async (valid) => {
        if (valid) {
          let res = await setAddEditor(this.ruleForm, this.type);
          if (res.success) {
            this.$message.success(res.msg);
            this.dialogVisible = false;
          }
        }
      });
    },
    // 返回数据库列表
    async getDsName() {
      let res = await setDsList();
      this.sourceOption = res.data;
      this.ruleForm.schema_name = "";
      this.ruleForm.table_name = "";
      console.log(this.sourceOption);
    },
    // 获取schemeName
    async getSchemaName(ds_id) {
      // console.log("itemid", ds_id);
      let res = await setSchema({ ds_id });
      this.schemaOption = res?.data?.schema_name || [];
    },
    // 获取表格name
    async getTableName(schemaName) {
      const data = {
        ds_id: this.ruleForm.ds_id,
        schema_name: schemaName,
      };
      let res = await setTable(data);
      this.tableOption = res?.data?.table_name || [];
    },
    // 获取字段列表
    async getFiledInfo(talbeName) {
      const pamars = {
        ds_id: this.ruleForm.ds_id,
        schema_name: this.ruleForm.schema_name,
        table_name: talbeName,
      };
      let res = await setField(pamars);
      this.fieldList = res?.data?.fields || [];
    },
  },
};
</script>

<style scoped lang="scss">
.field_main {
  .field_head {
    font-weight: bold;
    color: black;
  }
}

.conn {
  float: right;
  margin: 15px 0;
}
</style>
